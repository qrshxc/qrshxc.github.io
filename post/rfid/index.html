<!doctype html><html lang=zh-cn data-theme-mode=auto><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>STM32与RFID模块(MFRC522)完全应用指南 | 黄小冲</title><meta name=description content="记录成长与学习的足迹"><script>window.siteConfig=JSON.parse('{"anchor_icon":null,"clipboard":{"copyright":{"content":"本文版权：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处！","count":50,"enable":false},"fail":"复制失败 (ﾟ⊿ﾟ)ﾂ","success":"复制成功(*^▽^*)"},"code_block":{"expand":true},"icon_font":"4552607_0khxww3tj3q9","outdate":{"daysago":180,"enable":false,"message":"本文最后更新于 {time}，请注意文中内容可能已经发生变化。"}}')</script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7c&amp;display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7c&amp;display=swap" media=print onload='this.media="all"'><link rel=preload href=//at.alicdn.com/t/c/font_4552607_0khxww3tj3q9.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=stylesheet href=/css/loader.min.2ad0e9bbffb534e893c0ecefc44787a277cf851387e8ad9dccfbc3a5f0886dbe.css><meta property="og:type" content="website"><meta property="og:title" content="STM32与RFID模块(MFRC522)完全应用指南 | 黄小冲"><meta property="og:description" content="记录成长与学习的足迹"><meta property="og:url" content="https://qrshxc.github.io/post/rfid/"><meta property="og:site_name" content="九思的博客"><meta property="og:image" content="/"><meta property="article:author" content="黄小冲"><meta property="article:published_time" content="2025-08-04T17:41:58+08:00"><meta property="article:modified_time" content="2025-08-04T17:41:58+08:00"><meta name=twitter:card content="summary"><meta name=twitter:image content="/"><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/main.min.63684398a9584d95e2411a922ec8187281bbab44ffd348e26a806cae3370a598.css><link rel=preload as=style href=https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.css onload='this.onload=null,this.rel="stylesheet"'><link rel=preload as=style href=https://npm.webcache.cn/katex@0.16.9/dist/katex.min.css onload='this.onload=null,this.rel="stylesheet"'><script src=https://npm.webcache.cn/pace-js@1.2.4/pace.min.js integrity=sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8 crossorigin=anonymous></script><link rel=stylesheet href=https://npm.webcache.cn/@reimujs/aos@0.1.0/dist/aos.css></head><body><div id=loader><div class="loading-left-bg loading-bg"></div><div class="loading-right-bg loading-bg"></div><div class=spinner-box><div class=loading-taichi><svg width="150" height="150" viewBox="0 0 1024 1024" class="icon" shape-rendering="geometricPrecision"><path d="M303.5 432a80 80 0 01-12 160 80 80 0 0112-160z" fill="#ff5252"/><path d="M512 65a447 447 0 010 894V929a417 417 0 000-834 417 417 0 000 834v30a447 447 0 010-894zm0 30A417 417 0 01929 512 208.5 208.5.0 01720.5 720.5V592a80 80 0 000-160 80 80 0 000 160V720.5A208.5 208.5.0 01512 512 208.5 208.5.0 00303.5 303.5 208.5 208.5.0 0095 512 417 417 0 01512 95z" fill="#ff5252"/></svg></div><div class=loading-word>正在努力打败拖延兽...</div></div></div></div><script>var time=null,startLoading=()=>{time=Date.now(),document.getElementById("loader").classList.remove("loading")},endLoading=()=>{time?Date.now()-time>500?(time=null,document.body.style.overflow="auto",document.getElementById("loader").classList.add("loading")):(setTimeout(endLoading,500-(Date.now()-time)),time=null):(document.body.style.overflow="auto",document.getElementById("loader").classList.add("loading"))};window.addEventListener("DOMContentLoaded",endLoading),document.getElementById("loader").addEventListener("click",endLoading)</script><div id=copy-tooltip style="pointer-events:none;opacity:0;transition:all .2s ease;position:fixed;top:50%;left:50%;z-index:999;transform:translate(-50%,-50%);color:#fff;background:rgba(0,0,0,.5);padding:10px 15px;border-radius:10px"></div><div id=container><div id=wrap><div id=header-nav><nav id=main-nav><span class=main-nav-link-wrap><div class='main-nav-icon icon rotate'>&#xe62b;</div><a class=main-nav-link href=/>首页</a>
</span><span class=main-nav-link-wrap><div class='main-nav-icon icon rotate'>&#xe62b;</div><a class=main-nav-link href=/archives>归档</a>
</span><span class=main-nav-link-wrap><div class='main-nav-icon icon rotate'>&#xe62b;</div><a class=main-nav-link href=/about>关于</a>
</span><span class=main-nav-link-wrap><div class='main-nav-icon icon rotate'>&#xe62b;</div><a class=main-nav-link href=/friend>友链</a>
</span><a id=main-nav-toggle class=nav-icon></a></nav><nav id=sub-nav></nav></div><header id=header><picture></picture><img fetchpriority=high src=/images/banner.webp alt=STM32与RFID模块(MFRC522)完全应用指南><div id=header-outer><div id=header-title><a href=/ id=logo><h1 data-aos=slide-up>STM32与RFID模块(MFRC522)完全应用指南</h1></a><h2 id=subtitle-wrap data-aos=slide-down></h2></div></div></header><div id=content class=sidebar-right><aside id=sidebar><div class="sidebar-wrapper wrap-sticky"><div class=sidebar-wrap data-aos=fade-up><div class=sidebar-toc-sidebar><div class=sidebar-toc><h3 class=toc-title>文章目录</h3><div class="sidebar-toc-wrapper toc-div-class"><nav id=TableOfContents><ul><li><a href=#1-基本概念>1. 基本概念</a></li><li><a href=#2接口说明>2.接口说明</a></li><li><a href=#3工作模式>3.工作模式</a></li><li><a href=#4通信机制>4.通信机制</a></li><li><a href=#5访问流程>5.访问流程</a></li><li><a href=#6程序设计>6.程序设计</a><ul><li></li></ul></li></ul></nav></div></div></div><div class="sidebar-common-sidebar hidden"><div class=sidebar-author><img data-src=/avatar/avatar.webp data-sizes=auto alt=黄小冲 class=lazyload><div class=sidebar-author-name>黄小冲</div><div class=sidebar-description>记录成长与学习的足迹</div></div><div class=sidebar-state><div class=sidebar-state-article><div>文章</div><div class=sidebar-state-number>32</div></div><div class=sidebar-state-category><div>分类</div><div class=sidebar-state-number>0</div></div><div class=sidebar-state-tag><div>标签</div><div class=sidebar-state-number>0</div></div></div><div class=sidebar-social><div class="icon-github sidebar-social-icon"><a href=https://github.com/qrshxc itemprop=url target=_blank aria-label=github rel="noopener external nofollow noreferrer"></a></div><div class="icon-google sidebar-social-icon"><a href=https://plus.google.com/crees itemprop=url target=_blank aria-label=google rel="noopener external nofollow noreferrer"></a></div></div><div class=sidebar-menu><div class=sidebar-menu-link-wrap><a class=sidebar-menu-link-dummy href=/ aria-label=首页></a><div class='sidebar-menu-icon icon rotate'>&#xe62b;</div><div class=sidebar-menu-link>首页</div></div><div class=sidebar-menu-link-wrap><a class=sidebar-menu-link-dummy href=/archives aria-label=归档></a><div class='sidebar-menu-icon icon rotate'>&#xe62b;</div><div class=sidebar-menu-link>归档</div></div><div class=sidebar-menu-link-wrap><a class=sidebar-menu-link-dummy href=/about aria-label=关于></a><div class='sidebar-menu-icon icon rotate'>&#xe62b;</div><div class=sidebar-menu-link>关于</div></div><div class=sidebar-menu-link-wrap><a class=sidebar-menu-link-dummy href=/friend aria-label=友链></a><div class='sidebar-menu-icon icon rotate'>&#xe62b;</div><div class=sidebar-menu-link>友链</div></div></div></div><div class=sidebar-btn-wrapper style=position:static><div class="sidebar-toc-btn current"></div><div class=sidebar-common-btn></div></div></div></div><div class=sidebar-widget></div></aside><section id=main><article class="h-entry article" itemprop=blogPost itemscope itemtype=https://schema.org/BlogPosting><div class=article-inner data-aos=fade-up><div class=article-meta><div class=article-date><span class=article-date-link data-aos=zoom-in><time datetime="2025-08-04 17:41:58 +0800 +0800" itemprop=datePublished>2025-08-04</time>
<time style=display:none id=post-update-time>2025-08-04</time></span></div><div class=article-category></div></div><div class=hr-line></div><div class="e-content article-entry" itemprop=articleBody><h1 id=一rfid-模块的原理与应用><a class=header-anchor href=#%e4%b8%80rfid-%e6%a8%a1%e5%9d%97%e7%9a%84%e5%8e%9f%e7%90%86%e4%b8%8e%e5%ba%94%e7%94%a8></a>一、RFID 模块的原理与应用</h1><h2 id=1-基本概念><a class=header-anchor href=#1-%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5></a>1. 基本概念</h2><p>RFID 技术也简称为射频识别技术，是20 世纪40 年代开始出现的一种自动识别技术。RFID通过无线射频信号获取物体的相关数据，并对物体加以识别，RFID 技术不需要和被识别物体进行直接接触就可以完成物体信息的处理，也不需要人工干预，可以实现无接触式信息传递，能应用在各种较为恶劣的环境中。所以说RFID 技术是一种快速、高效的采集和处理物体信息的自动识别技术。</p><p>随着计算机和互联网的发展，物联网的概念也被提出，而物联网想要实现的是“万物互联”物联网的核心思想是为全球每一个物品提供唯一的电子标签，而RFID 可以实现无接触式的信息传递达到识别物体的目的。所以RFID 技术也是实现物联网的关键技术之一。RFID 技术的实现离不开软件与硬件的支持，硬件一般包含应答器、天线和阅读器。软件一般包含数据管理系统。</p><p>电子标签也叫作应答器，一般是由集成电路芯片和内置天线组成的，芯片用来存储物体相关数据，内置天线用来收发无线电波。电子标签一般附着在物体上用来标识物体，每个标签具有唯一的电子编码。电子标签的种类有很多，比如低频标签、高频标签等，并且电子标签的样式也有多种，比如条型、卡片型、环型、纽扣型等。</p><p><img src=https://raw.githubusercontent.com/qrshxc/img/main/image-20251122141541215.png alt=image-20251122141541215></p><p>而对于识读器而言，也称为阅读器或者读写器，是对电子标签信息读取和写入的设备。阅读器可以和计算机进行联网，作用一般是作为数据交换的媒介，阅读器一般由射频模块、控制模块和天线组成。也可以把阅读器理解为一个特殊的无线通信模块，它可以和电子标签通过天线进行无线通信。阅读器可以工作在一个或多个工作频段，也可以读写一种或多种电子标签，阅读器的种类有很多，比如手持式的、固定式的，使用起来非常方便。</p><h2 id=2接口说明><a class=header-anchor href=#2%e6%8e%a5%e5%8f%a3%e8%af%b4%e6%98%8e></a>2.接口说明</h2><p>本次使用RFID 模块内部采用的IC 是MFRC522 型号，需要阅读IC 的数据手册，了解该IC 的接口，可以知道RFID 模块支持SPI 接口。</p><p><img src=https://raw.githubusercontent.com/qrshxc/img/main/image-20251122141646343.png alt=image-20251122141646343></p><h2 id=3工作模式><a class=header-anchor href=#3%e5%b7%a5%e4%bd%9c%e6%a8%a1%e5%bc%8f></a>3.工作模式</h2><p><img src=https://raw.githubusercontent.com/qrshxc/img/main/image-20251122141717884.png alt=image-20251122141717884></p><h2 id=4通信机制><a class=header-anchor href=#4%e9%80%9a%e4%bf%a1%e6%9c%ba%e5%88%b6></a>4.通信机制</h2><p><img src=https://raw.githubusercontent.com/qrshxc/img/main/image-20251122141800592.png alt=image-20251122141800592></p><h2 id=5访问流程><a class=header-anchor href=#5%e8%ae%bf%e9%97%ae%e6%b5%81%e7%a8%8b></a>5.访问流程</h2><p><img src=https://raw.githubusercontent.com/qrshxc/img/main/image-20251122141856679.png alt=image-20251122141856679></p><h2 id=6程序设计><a class=header-anchor href=#6%e7%a8%8b%e5%ba%8f%e8%ae%be%e8%ae%a1></a>6.程序设计</h2><h4 id=mainc><a class=header-anchor href=#mainc></a>main.c</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>******************************************************************************
</span></span></span><span class=line><span class=cl><span class=cm>* @file    main.c 
</span></span></span><span class=line><span class=cl><span class=cm>* @author  qrshxc@163.com
</span></span></span><span class=line><span class=cl><span class=cm>* @version V1.0
</span></span></span><span class=line><span class=cl><span class=cm>* @date    2025.08.04
</span></span></span><span class=line><span class=cl><span class=cm>* @brief   FLASH
</span></span></span><span class=line><span class=cl><span class=cm>			CS--PB14
</span></span></span><span class=line><span class=cl><span class=cm>			MISO--PB4
</span></span></span><span class=line><span class=cl><span class=cm>			MOSI--PB5
</span></span></span><span class=line><span class=cl><span class=cm>			CLK--PB3
</span></span></span><span class=line><span class=cl><span class=cm>******************************************************************************
</span></span></span><span class=line><span class=cl><span class=cm>**/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;stm32f4xx.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;delay.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;MFRC522.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span><span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span><span class=cpf>&lt;stdbool.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>delay_us</span><span class=p>(</span><span class=n>u32</span> <span class=n>nus</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>delay_ms</span><span class=p>(</span><span class=n>u32</span> <span class=n>nus</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*USART1中断函数*/</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>USART1_IRQHandler</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* USART in Receiver mode */</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=nf>USART_GetITStatus</span><span class=p>(</span><span class=n>USART1</span><span class=p>,</span> <span class=n>USART_IT_RXNE</span><span class=p>)</span> <span class=o>==</span> <span class=n>SET</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=cm>/* 接收数据，一次一个字节 */</span>
</span></span><span class=line><span class=cl>		<span class=kt>int</span> <span class=n>a</span> <span class=o>=</span> <span class=nf>USART_ReceiveData</span><span class=p>(</span><span class=n>USART1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=cm>/* 发送数据 */</span>
</span></span><span class=line><span class=cl>		<span class=nf>USART_SendData</span><span class=p>(</span><span class=n>USART1</span><span class=p>,</span><span class=n>a</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/*USART1配置*/</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>USART1_Config</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>baud</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>USART_InitTypeDef</span> <span class=n>USART_InitStructure</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>NVIC_InitTypeDef</span> <span class=n>NVIC_InitStructure</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitTypeDef</span> <span class=n>GPIO_InitStructure</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/*打开GPIO时钟*/</span>	
</span></span><span class=line><span class=cl>	<span class=nf>RCC_AHB1PeriphClockCmd</span><span class=p>(</span><span class=n>RCC_AHB1Periph_GPIOA</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* 打开USART1时钟 */</span>
</span></span><span class=line><span class=cl>	<span class=nf>RCC_APB2PeriphClockCmd</span><span class=p>(</span><span class=n>RCC_APB2Periph_USART1</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>	
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=cm>/* 设置PA9和PA10的复用功能 */</span>
</span></span><span class=line><span class=cl>	<span class=nf>GPIO_PinAFConfig</span><span class=p>(</span><span class=n>GPIOA</span><span class=p>,</span> <span class=n>GPIO_PinSource9</span><span class=p>,</span> <span class=n>GPIO_AF_USART1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>GPIO_PinAFConfig</span><span class=p>(</span><span class=n>GPIOA</span><span class=p>,</span> <span class=n>GPIO_PinSource10</span><span class=p>,</span> <span class=n>GPIO_AF_USART1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=cm>/* 配置GPIO的复用功能+初始化 */</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Mode</span> <span class=o>=</span> <span class=n>GPIO_Mode_AF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Speed</span> <span class=o>=</span> <span class=n>GPIO_Speed_100MHz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_OType</span> <span class=o>=</span> <span class=n>GPIO_OType_PP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_PuPd</span> <span class=o>=</span> <span class=n>GPIO_PuPd_UP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Pin</span> <span class=o>=</span>  <span class=n>GPIO_Pin_9</span><span class=o>|</span><span class=n>GPIO_Pin_10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>GPIO_Init</span><span class=p>(</span><span class=n>GPIOA</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>GPIO_InitStructure</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* 配置USART1+初始化 */</span>
</span></span><span class=line><span class=cl>	<span class=n>USART_InitStructure</span><span class=p>.</span><span class=n>USART_BaudRate</span> <span class=o>=</span> <span class=n>baud</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>USART_InitStructure</span><span class=p>.</span><span class=n>USART_WordLength</span> <span class=o>=</span> <span class=n>USART_WordLength_8b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>USART_InitStructure</span><span class=p>.</span><span class=n>USART_StopBits</span> <span class=o>=</span> <span class=n>USART_StopBits_1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>USART_InitStructure</span><span class=p>.</span><span class=n>USART_Parity</span> <span class=o>=</span> <span class=n>USART_Parity_No</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>USART_InitStructure</span><span class=p>.</span><span class=n>USART_HardwareFlowControl</span> <span class=o>=</span> <span class=n>USART_HardwareFlowControl_None</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>USART_InitStructure</span><span class=p>.</span><span class=n>USART_Mode</span> <span class=o>=</span> <span class=n>USART_Mode_Rx</span><span class=o>|</span><span class=n>USART_Mode_Tx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>USART_Init</span><span class=p>(</span><span class=n>USART1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>USART_InitStructure</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=cm>/* 打开USART1中断 */</span>
</span></span><span class=line><span class=cl>	<span class=n>NVIC_InitStructure</span><span class=p>.</span><span class=n>NVIC_IRQChannel</span> <span class=o>=</span> <span class=n>USART1_IRQn</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>NVIC_InitStructure</span><span class=p>.</span><span class=n>NVIC_IRQChannelPreemptionPriority</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>NVIC_InitStructure</span><span class=p>.</span><span class=n>NVIC_IRQChannelSubPriority</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>NVIC_InitStructure</span><span class=p>.</span><span class=n>NVIC_IRQChannelCmd</span> <span class=o>=</span> <span class=n>ENABLE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>NVIC_Init</span><span class=p>(</span><span class=o>&amp;</span><span class=n>NVIC_InitStructure</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=cm>/*  */</span>
</span></span><span class=line><span class=cl>	<span class=nf>USART_ITConfig</span><span class=p>(</span><span class=n>USART1</span><span class=p>,</span> <span class=n>USART_IT_RXNE</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/* 打开USART */</span>
</span></span><span class=line><span class=cl>	<span class=nf>USART_Cmd</span><span class=p>(</span><span class=n>USART1</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>USART1_SendString</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span><span class=p>(</span><span class=o>*</span><span class=n>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>USART_SendData</span><span class=p>(</span><span class=n>USART1</span><span class=p>,</span><span class=o>*</span><span class=n>str</span><span class=o>++</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>while</span><span class=p>(</span><span class=o>!</span><span class=nf>USART_GetFlagStatus</span><span class=p>(</span><span class=n>USART1</span><span class=p>,</span> <span class=n>USART_FLAG_TXE</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* 蜂鸣器初始化*/</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Beep_Config</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* 定义GPIO外设的结构体变量 */</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitTypeDef</span>  <span class=n>GPIO_InitStructure</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=cm>/* 使能GPIOF端口的时钟 */</span>
</span></span><span class=line><span class=cl>    <span class=nf>RCC_AHB1PeriphClockCmd</span><span class=p>(</span><span class=n>RCC_AHB1Periph_GPIOF</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=cm>/* 对PF9引脚进行配置 */</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Pin</span>   <span class=o>=</span> <span class=n>GPIO_Pin_8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Mode</span>  <span class=o>=</span> <span class=n>GPIO_Mode_OUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_OType</span> <span class=o>=</span> <span class=n>GPIO_OType_PP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Speed</span> <span class=o>=</span> <span class=n>GPIO_Speed_100MHz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_PuPd</span>  <span class=o>=</span> <span class=n>GPIO_PuPd_NOPULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>GPIO_Init</span><span class=p>(</span><span class=n>GPIOF</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>GPIO_InitStructure</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=nf>GPIO_ResetBits</span><span class=p>(</span><span class=n>GPIOF</span><span class=p>,</span> <span class=n>GPIO_Pin_8</span><span class=p>);</span> <span class=c1>// 默认不响
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* LED灯初始化*/</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>Led1_Config</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=cm>/* 定义GPIO外设的结构体变量 */</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitTypeDef</span>  <span class=n>GPIO_InitStructure</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=cm>/* 使能GPIOF端口的时钟 */</span>
</span></span><span class=line><span class=cl>    <span class=nf>RCC_AHB1PeriphClockCmd</span><span class=p>(</span><span class=n>RCC_AHB1Periph_GPIOF</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=cm>/* 对PF9引脚进行配置 */</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Pin</span>   <span class=o>=</span> <span class=n>GPIO_Pin_9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Mode</span>  <span class=o>=</span> <span class=n>GPIO_Mode_OUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_OType</span> <span class=o>=</span> <span class=n>GPIO_OType_PP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Speed</span> <span class=o>=</span> <span class=n>GPIO_Speed_100MHz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_PuPd</span>  <span class=o>=</span> <span class=n>GPIO_PuPd_NOPULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>GPIO_Init</span><span class=p>(</span><span class=n>GPIOF</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>GPIO_InitStructure</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>GPIO_SetBits</span><span class=p>(</span><span class=n>GPIOF</span><span class=p>,</span> <span class=n>GPIO_Pin_9</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span> <span class=n>buff</span><span class=p>[</span><span class=mi>128</span><span class=p>]</span><span class=o>=</span><span class=p>{</span><span class=mi>0</span><span class=p>};</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span>  <span class=n>card_pydebuf</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=n>u8</span>  <span class=n>card_numberbuf</span><span class=p>[</span><span class=mi>5</span><span class=p>];</span>
</span></span><span class=line><span class=cl>	<span class=nf>USART1_Config</span><span class=p>(</span><span class=mi>9600</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=nf>Beep_Config</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>MFRC522_Initializtion</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=nf>Led1_Config</span><span class=p>();</span>
</span></span><span class=line><span class=cl>	<span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=n>status</span><span class=o>=</span><span class=nf>MFRC522_Request</span><span class=p>(</span><span class=mh>0x52</span><span class=p>,</span> <span class=n>card_pydebuf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span><span class=p>(</span><span class=n>status</span><span class=o>==</span><span class=mi>0</span><span class=p>)</span>		<span class=c1>//如果读到卡
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>status</span><span class=o>=</span><span class=nf>MFRC522_Anticoll</span><span class=p>(</span><span class=n>card_numberbuf</span><span class=p>);</span>			<span class=c1>//防撞处理
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nf>sprintf</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>buff</span><span class=p>,</span><span class=s>&#34;ID card: 0X%02X%02X%02X%02X</span><span class=se>\r\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>card_numberbuf</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=n>card_numberbuf</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=n>card_numberbuf</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span><span class=n>card_numberbuf</span><span class=p>[</span><span class=mi>3</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>			<span class=nf>USART1_SendString</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>buff</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span><span class=p>(</span><span class=n>card_numberbuf</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=mh>0x03</span> <span class=o>&amp;&amp;</span> <span class=n>card_numberbuf</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=mh>0x86</span> <span class=o>&amp;&amp;</span> 
</span></span><span class=line><span class=cl>               <span class=n>card_numberbuf</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>==</span> <span class=mh>0x1C</span> <span class=o>&amp;&amp;</span> <span class=n>card_numberbuf</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>==</span> <span class=mh>0x06</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>GPIO_SetBits</span><span class=p>(</span><span class=n>GPIOF</span><span class=p>,</span> <span class=n>GPIO_Pin_8</span><span class=p>);</span>  <span class=c1>// 响蜂鸣器
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nf>delay_ms</span><span class=p>(</span><span class=mi>2000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nf>GPIO_ResetBits</span><span class=p>(</span><span class=n>GPIOF</span><span class=p>,</span> <span class=n>GPIO_Pin_8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>GPIO_ResetBits</span><span class=p>(</span><span class=n>GPIOF</span><span class=p>,</span> <span class=n>GPIO_Pin_8</span><span class=p>);</span>  <span class=c1>// 关闭蜂鸣器
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>}</span>
</span></span><span class=line><span class=cl>			
</span></span><span class=line><span class=cl>			<span class=k>if</span><span class=p>(</span><span class=n>card_numberbuf</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=mh>0xAA</span> <span class=o>&amp;&amp;</span> <span class=n>card_numberbuf</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=mh>0x02</span> <span class=o>&amp;&amp;</span> 
</span></span><span class=line><span class=cl>               <span class=n>card_numberbuf</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>==</span> <span class=mh>0xCE</span> <span class=o>&amp;&amp;</span> <span class=n>card_numberbuf</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>==</span> <span class=mh>0x99</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nf>GPIO_ResetBits</span><span class=p>(</span><span class=n>GPIOF</span><span class=p>,</span> <span class=n>GPIO_Pin_9</span><span class=p>);</span><span class=c1>// 开灯
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nf>delay_ms</span><span class=p>(</span><span class=mi>2000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>				<span class=nf>GPIO_SetBits</span><span class=p>(</span><span class=n>GPIOF</span><span class=p>,</span> <span class=n>GPIO_Pin_9</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nf>GPIO_SetBits</span><span class=p>(</span><span class=n>GPIOF</span><span class=p>,</span> <span class=n>GPIO_Pin_9</span><span class=p>);</span>  <span class=c1>// 关灯
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>}</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>			
</span></span><span class=line><span class=cl>			<span class=nf>delay_ms</span><span class=p>(</span><span class=mi>500</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=mfrc522h><a class=header-anchor href=#mfrc522h></a>mfrc522.h</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> ******************************************************************************
</span></span></span><span class=line><span class=cl><span class=cm> * @file    mfrc522.h 
</span></span></span><span class=line><span class=cl><span class=cm> * @author  qrshxc@163.com
</span></span></span><span class=line><span class=cl><span class=cm> * @version V1.0
</span></span></span><span class=line><span class=cl><span class=cm> * @brief   MFRC522 RFID读写器驱动头文件
</span></span></span><span class=line><span class=cl><span class=cm> *          引脚定义：
</span></span></span><span class=line><span class=cl><span class=cm> *          CS   -- PE0 输出模式
</span></span></span><span class=line><span class=cl><span class=cm> *          SCK  -- PE1 输出模式  
</span></span></span><span class=line><span class=cl><span class=cm> *          MOSI -- PE2 输出模式
</span></span></span><span class=line><span class=cl><span class=cm> *          MISO -- PE3 输入模式
</span></span></span><span class=line><span class=cl><span class=cm> *          RST  -- PE5 输出模式
</span></span></span><span class=line><span class=cl><span class=cm> *          GND  -- GND
</span></span></span><span class=line><span class=cl><span class=cm> *          VCC  -- 3.3V
</span></span></span><span class=line><span class=cl><span class=cm> ******************************************************************************
</span></span></span><span class=line><span class=cl><span class=cm> **/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#ifndef _MFRC522_H_
</span></span></span><span class=line><span class=cl><span class=cp>#define _MFRC522_H_
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;stm32f4xx.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* MFRC522引脚操作宏定义 */</span>
</span></span><span class=line><span class=cl><span class=cp>#define MFRC522_CS(x)    ((x) ? GPIO_SetBits(GPIOE, GPIO_Pin_0) : GPIO_ResetBits(GPIOE, GPIO_Pin_0))
</span></span></span><span class=line><span class=cl><span class=cp>#define MFRC522_RST(x)   ((x) ? GPIO_SetBits(GPIOE, GPIO_Pin_5) : GPIO_ResetBits(GPIOE, GPIO_Pin_5))
</span></span></span><span class=line><span class=cl><span class=cp>#define MFRC522_SCK(n)   ((n) ? GPIO_SetBits(GPIOE, GPIO_Pin_1) : GPIO_ResetBits(GPIOE, GPIO_Pin_1))
</span></span></span><span class=line><span class=cl><span class=cp>#define MFRC522_MOSI(n)  ((n) ? GPIO_SetBits(GPIOE, GPIO_Pin_2) : GPIO_ResetBits(GPIOE, GPIO_Pin_2))
</span></span></span><span class=line><span class=cl><span class=cp>#define MFRC522_MISO     GPIO_ReadInputDataBit(GPIOE, GPIO_Pin_3)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* MF522命令字 */</span>
</span></span><span class=line><span class=cl><span class=cp>#define PCD_IDLE              0x00               </span><span class=c1>//取消当前命令
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PCD_AUTHENT           0x0E               </span><span class=c1>//验证密钥
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PCD_RECEIVE           0x08               </span><span class=c1>//接收数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PCD_TRANSMIT          0x04               </span><span class=c1>//发送数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PCD_TRANSCEIVE        0x0C               </span><span class=c1>//发送并接收数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PCD_RESETPHASE        0x0F               </span><span class=c1>//复位
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PCD_CALCCRC           0x03               </span><span class=c1>//CRC计算
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/* Mifare_One卡片命令字 */</span>
</span></span><span class=line><span class=cl><span class=cp>#define PICC_REQIDL           0x26               </span><span class=c1>//寻天线区内未进入休眠状态
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PICC_REQALL           0x52               </span><span class=c1>//寻天线区内全部卡
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PICC_ANTICOLL1        0x93               </span><span class=c1>//防冲撞
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PICC_ANTICOLL2        0x95               </span><span class=c1>//防冲撞
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PICC_AUTHENT1A        0x60               </span><span class=c1>//验证A密钥
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PICC_AUTHENT1B        0x61               </span><span class=c1>//验证B密钥
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PICC_READ             0x30               </span><span class=c1>//读块
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PICC_WRITE            0xA0               </span><span class=c1>//写块
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PICC_DECREMENT        0xC0               </span><span class=c1>//扣款
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PICC_INCREMENT        0xC1               </span><span class=c1>//充值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PICC_RESTORE          0xC2               </span><span class=c1>//调块数据到缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PICC_TRANSFER         0xB0               </span><span class=c1>//保存缓冲区中数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define PICC_HALT             0x50               </span><span class=c1>//休眠
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/* MF522 FIFO长度定义 */</span>
</span></span><span class=line><span class=cl><span class=cp>#define DEF_FIFO_LENGTH       64                 </span><span class=c1>//FIFO size=64byte
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/* MF522寄存器定义 */</span>
</span></span><span class=line><span class=cl><span class=c1>// PAGE 0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define RFU00                 0x00    
</span></span></span><span class=line><span class=cl><span class=cp>#define CommandReg            0x01    
</span></span></span><span class=line><span class=cl><span class=cp>#define ComIEnReg             0x02    
</span></span></span><span class=line><span class=cl><span class=cp>#define DivlEnReg             0x03    
</span></span></span><span class=line><span class=cl><span class=cp>#define ComIrqReg             0x04    
</span></span></span><span class=line><span class=cl><span class=cp>#define DivIrqReg             0x05
</span></span></span><span class=line><span class=cl><span class=cp>#define ErrorReg              0x06    
</span></span></span><span class=line><span class=cl><span class=cp>#define Status1Reg            0x07    
</span></span></span><span class=line><span class=cl><span class=cp>#define Status2Reg            0x08    
</span></span></span><span class=line><span class=cl><span class=cp>#define FIFODataReg           0x09
</span></span></span><span class=line><span class=cl><span class=cp>#define FIFOLevelReg          0x0A
</span></span></span><span class=line><span class=cl><span class=cp>#define WaterLevelReg         0x0B
</span></span></span><span class=line><span class=cl><span class=cp>#define ControlReg            0x0C
</span></span></span><span class=line><span class=cl><span class=cp>#define BitFramingReg         0x0D
</span></span></span><span class=line><span class=cl><span class=cp>#define CollReg               0x0E
</span></span></span><span class=line><span class=cl><span class=cp>#define RFU0F                 0x0F
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// PAGE 1     
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define RFU10                 0x10
</span></span></span><span class=line><span class=cl><span class=cp>#define ModeReg               0x11
</span></span></span><span class=line><span class=cl><span class=cp>#define TxModeReg             0x12
</span></span></span><span class=line><span class=cl><span class=cp>#define RxModeReg             0x13
</span></span></span><span class=line><span class=cl><span class=cp>#define TxControlReg          0x14
</span></span></span><span class=line><span class=cl><span class=cp>#define TxAutoReg             0x15
</span></span></span><span class=line><span class=cl><span class=cp>#define TxSelReg              0x16
</span></span></span><span class=line><span class=cl><span class=cp>#define RxSelReg              0x17
</span></span></span><span class=line><span class=cl><span class=cp>#define RxThresholdReg        0x18
</span></span></span><span class=line><span class=cl><span class=cp>#define DemodReg              0x19
</span></span></span><span class=line><span class=cl><span class=cp>#define RFU1A                 0x1A
</span></span></span><span class=line><span class=cl><span class=cp>#define RFU1B                 0x1B
</span></span></span><span class=line><span class=cl><span class=cp>#define RFU1C             	  0x1C
</span></span></span><span class=line><span class=cl><span class=cp>#define RFU1D                 0x1D
</span></span></span><span class=line><span class=cl><span class=cp>#define RFU1E                 0x1E
</span></span></span><span class=line><span class=cl><span class=cp>#define SerialSpeedReg        0x1F
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// PAGE 2    
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define RFU20                 0x20  
</span></span></span><span class=line><span class=cl><span class=cp>#define CRCResultRegH         0x21
</span></span></span><span class=line><span class=cl><span class=cp>#define CRCResultRegL         0x22
</span></span></span><span class=line><span class=cl><span class=cp>#define RFU23                 0x23
</span></span></span><span class=line><span class=cl><span class=cp>#define ModWidthReg           0x24
</span></span></span><span class=line><span class=cl><span class=cp>#define RFU25                 0x25
</span></span></span><span class=line><span class=cl><span class=cp>#define RFCfgReg              0x26
</span></span></span><span class=line><span class=cl><span class=cp>#define GsNReg                0x27
</span></span></span><span class=line><span class=cl><span class=cp>#define CWGsCfgReg            0x28
</span></span></span><span class=line><span class=cl><span class=cp>#define ModGsCfgReg           0x29
</span></span></span><span class=line><span class=cl><span class=cp>#define TModeReg              0x2A
</span></span></span><span class=line><span class=cl><span class=cp>#define TPrescalerReg         0x2B
</span></span></span><span class=line><span class=cl><span class=cp>#define TReloadRegH           0x2C
</span></span></span><span class=line><span class=cl><span class=cp>#define TReloadRegL           0x2D
</span></span></span><span class=line><span class=cl><span class=cp>#define TCounterValueRegH     0x2E
</span></span></span><span class=line><span class=cl><span class=cp>#define TCounterValueRegL     0x2F
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// PAGE 3      
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define RFU30                 0x30
</span></span></span><span class=line><span class=cl><span class=cp>#define TestSel1Reg           0x31
</span></span></span><span class=line><span class=cl><span class=cp>#define TestSel2Reg           0x32
</span></span></span><span class=line><span class=cl><span class=cp>#define TestPinEnReg          0x33
</span></span></span><span class=line><span class=cl><span class=cp>#define TestPinValueReg       0x34
</span></span></span><span class=line><span class=cl><span class=cp>#define TestBusReg            0x35
</span></span></span><span class=line><span class=cl><span class=cp>#define AutoTestReg           0x36
</span></span></span><span class=line><span class=cl><span class=cp>#define VersionReg            0x37
</span></span></span><span class=line><span class=cl><span class=cp>#define AnalogTestReg         0x38
</span></span></span><span class=line><span class=cl><span class=cp>#define TestDAC1Reg           0x39  
</span></span></span><span class=line><span class=cl><span class=cp>#define TestDAC2Reg           0x3A   
</span></span></span><span class=line><span class=cl><span class=cp>#define TestADCReg            0x3B   
</span></span></span><span class=line><span class=cl><span class=cp>#define RFU3C                 0x3C   
</span></span></span><span class=line><span class=cl><span class=cp>#define RFU3D                 0x3D   
</span></span></span><span class=line><span class=cl><span class=cp>#define RFU3E                 0x3E   
</span></span></span><span class=line><span class=cl><span class=cp>#define RFU3F		  		  0x3F
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* 通讯错误代码 */</span>
</span></span><span class=line><span class=cl><span class=cp>#define MI_OK                 0
</span></span></span><span class=line><span class=cl><span class=cp>#define MI_NOTAGERR           1
</span></span></span><span class=line><span class=cl><span class=cp>#define MI_ERR                2
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define MAX_LEN               18
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* 外部变量声明 */</span>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=n>u8</span> <span class=n>irq_regdata</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=n>u16</span> <span class=n>wait_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=n>u8</span> <span class=n>error_regdata</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>extern</span> <span class=n>u8</span> <span class=n>last_bitsdata</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* 函数声明 */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_Delay1us</span><span class=p>(</span><span class=n>u16</span> <span class=n>count</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_SPI_Init</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>uint8_t</span> <span class=nf>MFRC522_SPI_Send</span><span class=p>(</span><span class=n>u8</span> <span class=n>val</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_Initializtion</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>u8</span> <span class=n>addr</span><span class=p>,</span> <span class=n>u8</span> <span class=n>val</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>MFRC522_ReadReg</span><span class=p>(</span><span class=n>u8</span> <span class=n>addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_SetBitMask</span><span class=p>(</span><span class=n>u8</span> <span class=n>reg</span><span class=p>,</span> <span class=n>u8</span> <span class=n>mask</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_ClearBitMask</span><span class=p>(</span><span class=n>u8</span> <span class=n>reg</span><span class=p>,</span> <span class=n>u8</span> <span class=n>mask</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_AntennaOn</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_AntennaOff</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_Reset</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>MFRC522_ToCard</span><span class=p>(</span><span class=n>u8</span> <span class=n>command</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>sendData</span><span class=p>,</span> <span class=n>u8</span> <span class=n>sendLen</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>backData</span><span class=p>,</span> <span class=n>u16</span> <span class=o>*</span><span class=n>backLen</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>MFRC522_Request</span><span class=p>(</span><span class=n>u8</span> <span class=n>reqMode</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>TagType</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>MFRC522_Anticoll</span><span class=p>(</span><span class=n>u8</span> <span class=o>*</span><span class=n>serNum</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_CalulateCRC</span><span class=p>(</span><span class=n>u8</span> <span class=o>*</span><span class=n>pIndata</span><span class=p>,</span> <span class=n>u8</span> <span class=n>len</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>pOutData</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>MFRC522_SelectTag</span><span class=p>(</span><span class=n>u8</span> <span class=o>*</span><span class=n>serNum</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>MFRC522_Auth</span><span class=p>(</span><span class=n>u8</span> <span class=n>authMode</span><span class=p>,</span> <span class=n>u8</span> <span class=n>BlockAddr</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>Sectorkey</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>serNum</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>MFRC522_ReadBlock</span><span class=p>(</span><span class=n>u8</span> <span class=n>blockAddr</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>recvData</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>MFRC522_WriteBlock</span><span class=p>(</span><span class=n>u8</span> <span class=n>blockAddr</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>writeData</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_Halt</span><span class=p>(</span><span class=kt>void</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#endif </span><span class=cm>/* _MFRC522_H_ */</span><span class=cp>
</span></span></span></code></pre></div><h4 id=mfrc522c><a class=header-anchor href=#mfrc522c></a>mfrc522.c</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> ******************************************************************************
</span></span></span><span class=line><span class=cl><span class=cm> * @file    mfrc522.c 
</span></span></span><span class=line><span class=cl><span class=cm> * @author  qrshxc@163.com
</span></span></span><span class=line><span class=cl><span class=cm> * @version V1.0
</span></span></span><span class=line><span class=cl><span class=cm> * @brief   MFRC522 RFID读写器驱动实现
</span></span></span><span class=line><span class=cl><span class=cm> ******************************************************************************
</span></span></span><span class=line><span class=cl><span class=cm> **/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;MFRC522.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;delay.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/* 全局变量 */</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=n>irq_regdata</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>u16</span> <span class=n>wait_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=n>error_regdata</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=n>last_bitsdata</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  微秒延时函数
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  count: 延时计数
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval None
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_Delay1us</span><span class=p>(</span><span class=n>u16</span> <span class=n>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u16</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>u8</span> <span class=n>us</span> <span class=o>=</span> <span class=mi>12</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span><span class=p>(</span><span class=n>us</span><span class=o>--</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  SPI3初始化
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  None
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval None
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_SPI_Init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>GPIO_InitTypeDef</span> <span class=n>GPIO_InitStructure</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 使能GPIOE时钟 */</span>
</span></span><span class=line><span class=cl>    <span class=nf>RCC_AHB1PeriphClockCmd</span><span class=p>(</span><span class=n>RCC_AHB1Periph_GPIOE</span><span class=p>,</span> <span class=n>ENABLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 配置SPI引脚 */</span>
</span></span><span class=line><span class=cl>    <span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Mode</span> <span class=o>=</span> <span class=n>GPIO_Mode_OUT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Speed</span> <span class=o>=</span> <span class=n>GPIO_Speed_50MHz</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_OType</span> <span class=o>=</span> <span class=n>GPIO_OType_PP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_PuPd</span> <span class=o>=</span> <span class=n>GPIO_PuPd_DOWN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Pin</span> <span class=o>=</span> <span class=n>GPIO_Pin_0</span> <span class=o>|</span> <span class=n>GPIO_Pin_1</span> <span class=o>|</span> <span class=n>GPIO_Pin_2</span> <span class=o>|</span> <span class=n>GPIO_Pin_5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>GPIO_Init</span><span class=p>(</span><span class=n>GPIOE</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>GPIO_InitStructure</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* 配置MISO引脚为输入模式 */</span>
</span></span><span class=line><span class=cl>    <span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Pin</span> <span class=o>=</span> <span class=n>GPIO_Pin_3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>GPIO_InitStructure</span><span class=p>.</span><span class=n>GPIO_Mode</span> <span class=o>=</span> <span class=n>GPIO_Mode_IN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>GPIO_Init</span><span class=p>(</span><span class=n>GPIOE</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>GPIO_InitStructure</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 取消片选，SCK置高 */</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_CS</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_SCK</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  SPI发送接收数据
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  val: 要发送的数据
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval 接收到的数据
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=kt>uint8_t</span> <span class=nf>MFRC522_SPI_Send</span><span class=p>(</span><span class=n>u8</span> <span class=n>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>data</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_SCK</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>delay_us</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 循环发送8次，MSB高位先出 */</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* 判断待发送字节的最高位 */</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>val</span> <span class=o>&amp;</span> <span class=mh>0x80</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>MFRC522_MOSI</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=nf>MFRC522_MOSI</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>delay_us</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=cm>/* SCK输出高电平，第一个边沿出现 */</span>
</span></span><span class=line><span class=cl>        <span class=nf>MFRC522_SCK</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>delay_us</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=cm>/* 接收从机响应的bit */</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>|=</span> <span class=n>MFRC522_MISO</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>delay_us</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=cm>/* SCK输出低电平，第二个边沿出现 */</span>
</span></span><span class=line><span class=cl>        <span class=nf>MFRC522_SCK</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>delay_us</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  向MFRC522寄存器写一个字节
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  addr: 寄存器地址
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  val: 要写入的值
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval None
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>u8</span> <span class=n>addr</span><span class=p>,</span> <span class=n>u8</span> <span class=n>val</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* 地址格式: 0XXXXXX0 */</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_CS</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_SPI_Send</span><span class=p>((</span><span class=n>addr</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x7E</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_SPI_Send</span><span class=p>(</span><span class=n>val</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_CS</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  从MFRC522寄存器读一个字节
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  addr: 寄存器地址
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval 读取到的数据
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>MFRC522_ReadReg</span><span class=p>(</span><span class=n>u8</span> <span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 地址格式: 1XXXXXX0 */</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_CS</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_SPI_Send</span><span class=p>(((</span><span class=n>addr</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x7E</span><span class=p>)</span> <span class=o>|</span> <span class=mh>0x80</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>val</span> <span class=o>=</span> <span class=nf>MFRC522_SPI_Send</span><span class=p>(</span><span class=mh>0xFF</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_CS</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>val</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  置位RC522寄存器
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  reg: 寄存器地址
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  mask: 置位值
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval None
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_SetBitMask</span><span class=p>(</span><span class=n>u8</span> <span class=n>reg</span><span class=p>,</span> <span class=n>u8</span> <span class=n>mask</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>tmp</span> <span class=o>=</span> <span class=nf>MFRC522_ReadReg</span><span class=p>(</span><span class=n>reg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>reg</span><span class=p>,</span> <span class=n>tmp</span> <span class=o>|</span> <span class=n>mask</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  清除RC522寄存器位
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  reg: 寄存器地址
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  mask: 清位值
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval None
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_ClearBitMask</span><span class=p>(</span><span class=n>u8</span> <span class=n>reg</span><span class=p>,</span> <span class=n>u8</span> <span class=n>mask</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>tmp</span> <span class=o>=</span> <span class=nf>MFRC522_ReadReg</span><span class=p>(</span><span class=n>reg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>reg</span><span class=p>,</span> <span class=n>tmp</span> <span class=o>&amp;</span> <span class=p>(</span><span class=o>~</span><span class=n>mask</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  开启天线
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  None
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval None
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_AntennaOn</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>temp</span> <span class=o>=</span> <span class=nf>MFRC522_ReadReg</span><span class=p>(</span><span class=n>TxControlReg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=n>temp</span> <span class=o>&amp;</span> <span class=mh>0x03</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>MFRC522_SetBitMask</span><span class=p>(</span><span class=n>TxControlReg</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  关闭天线
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  None
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval None
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_AntennaOff</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_ClearBitMask</span><span class=p>(</span><span class=n>TxControlReg</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  复位MFRC522
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  None
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval None
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_Reset</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* 硬件复位 */</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_Rst</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>delay_us</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_Rst</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>delay_us</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_Rst</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>delay_us</span><span class=p>(</span><span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 软件复位 */</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>CommandReg</span><span class=p>,</span> <span class=n>PCD_RESETPHASE</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  MFRC522初始化
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  None
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval None
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_Initializtion</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_SPI_Init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_Reset</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 定时器配置: TPrescaler*TreloadVal/6.78MHz = 0xD3E*0x32/6.78=25ms */</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>TModeReg</span><span class=p>,</span> <span class=mh>0x8D</span><span class=p>);</span>        <span class=c1>// TAuto=1自动计数模式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>TPrescalerReg</span><span class=p>,</span> <span class=mh>0x3E</span><span class=p>);</span>   <span class=c1>// 预分频值低8位
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>TReloadRegL</span><span class=p>,</span> <span class=mh>0x32</span><span class=p>);</span>     <span class=c1>// 计数器低8位
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>TReloadRegH</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>);</span>     <span class=c1>// 计数器高8位
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>TxAutoReg</span><span class=p>,</span> <span class=mh>0x40</span><span class=p>);</span>       <span class=c1>// 100%ASK
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>ModeReg</span><span class=p>,</span> <span class=mh>0x3D</span><span class=p>);</span>         <span class=c1>// CRC初始值0x6363
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>CommandReg</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>);</span>      <span class=c1>// 启动MFRC522
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_AntennaOn</span><span class=p>();</span>                     <span class=c1>// 打开天线
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  RC522和ISO14443卡通讯
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  command: MF522命令字
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  sendData: 发送到卡片的数据
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  sendLen: 发送数据长度
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  backData: 接收到的返回数据
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  backLen: 返回数据的位长度
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval 成功返回MI_OK
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>MFRC522_ToCard</span><span class=p>(</span><span class=n>u8</span> <span class=n>command</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>sendData</span><span class=p>,</span> <span class=n>u8</span> <span class=n>sendLen</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>backData</span><span class=p>,</span> <span class=n>u16</span> <span class=o>*</span><span class=n>backLen</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>status</span> <span class=o>=</span> <span class=n>MI_ERR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>irqEn</span> <span class=o>=</span> <span class=mh>0x00</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>waitIRq</span> <span class=o>=</span> <span class=mh>0x00</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>lastBits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u16</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 根据命令预设中断参数 */</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span><span class=p>(</span><span class=n>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nl>PCD_AUTHENT</span><span class=p>:</span>                    <span class=c1>// 认证卡密
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>irqEn</span> <span class=o>=</span> <span class=mh>0x12</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>waitIRq</span> <span class=o>=</span> <span class=mh>0x10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nl>PCD_TRANSCEIVE</span><span class=p>:</span>                 <span class=c1>// 发送FIFO中数据
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>irqEn</span> <span class=o>=</span> <span class=mh>0x77</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>waitIRq</span> <span class=o>=</span> <span class=mh>0x30</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>ComIEnReg</span><span class=p>,</span> <span class=n>irqEn</span> <span class=o>|</span> <span class=mh>0x80</span><span class=p>);</span>      <span class=c1>// 允许中断请求
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>MFRC522_ClearBitMask</span><span class=p>(</span><span class=n>ComIrqReg</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>);</span>          <span class=c1>// 清除所有中断请求位
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>MFRC522_SetBitMask</span><span class=p>(</span><span class=n>FIFOLevelReg</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>);</span>         <span class=c1>// FlushBuffer=1, FIFO初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>CommandReg</span><span class=p>,</span> <span class=n>PCD_IDLE</span><span class=p>);</span>         <span class=c1>// 使MFRC522空闲
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 向FIFO中写入数据 */</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>sendLen</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>FIFODataReg</span><span class=p>,</span> <span class=n>sendData</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 执行命令 */</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>CommandReg</span><span class=p>,</span> <span class=n>command</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 天线发送数据 */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>command</span> <span class=o>==</span> <span class=n>PCD_TRANSCEIVE</span><span class=p>)</span>                    <span class=c1>// 卡片通信命令，开始向天线发送数据
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>MFRC522_SetBitMask</span><span class=p>(</span><span class=n>BitFramingReg</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>);</span>    <span class=c1>// StartSend=1,开始传输数据
</span></span></span><span class=line><span class=cl><span class=c1></span>        
</span></span><span class=line><span class=cl>    <span class=cm>/* 等待接收数据完成 */</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>10000</span><span class=p>;</span> <span class=c1>// 操作M1卡最大等待时间25ms
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>n</span> <span class=o>=</span> <span class=nf>MFRC522_ReadReg</span><span class=p>(</span><span class=n>ComIrqReg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>irq_regdata</span> <span class=o>=</span> <span class=n>n</span><span class=p>;</span>        <span class=c1>// 测试用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>i</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>wait_count</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>         <span class=c1>// 测试用
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>while</span><span class=p>((</span><span class=n>i</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>n</span> <span class=o>&amp;</span> <span class=mh>0x01</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>n</span> <span class=o>&amp;</span> <span class=n>waitIRq</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 停止发送 */</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_ClearBitMask</span><span class=p>(</span><span class=n>BitFramingReg</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>);</span>      <span class=c1>// StartSend=0
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 检查是否在25ms内读到卡 */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>i</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=nf>MFRC522_ReadReg</span><span class=p>(</span><span class=n>ErrorReg</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x1B</span><span class=p>))</span>     <span class=c1>// 检查错误标志
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=n>n</span> <span class=o>&amp;</span> <span class=n>irqEn</span> <span class=o>&amp;</span> <span class=mh>0x01</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>status</span> <span class=o>=</span> <span class=n>MI_NOTAGERR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=n>command</span> <span class=o>==</span> <span class=n>PCD_TRANSCEIVE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>n</span> <span class=o>=</span> <span class=nf>MFRC522_ReadReg</span><span class=p>(</span><span class=n>FIFOLevelReg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>lastBits</span> <span class=o>=</span> <span class=nf>MFRC522_ReadReg</span><span class=p>(</span><span class=n>ControlReg</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x07</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span><span class=p>(</span><span class=n>lastBits</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=o>*</span><span class=n>backLen</span> <span class=o>=</span> <span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=mi>8</span> <span class=o>+</span> <span class=n>lastBits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span>
</span></span><span class=line><span class=cl>                    <span class=o>*</span><span class=n>backLen</span> <span class=o>=</span> <span class=n>n</span> <span class=o>*</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span><span class=p>(</span><span class=n>n</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>n</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span><span class=p>(</span><span class=n>n</span> <span class=o>&gt;</span> <span class=n>MAX_LEN</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>n</span> <span class=o>=</span> <span class=n>MAX_LEN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=cm>/* 读取接收到的数据 */</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>backData</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=nf>MFRC522_ReadReg</span><span class=p>(</span><span class=n>FIFODataReg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>status</span> <span class=o>=</span> <span class=n>MI_OK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>status</span> <span class=o>=</span> <span class=n>MI_ERR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>ControlReg</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>);</span>             <span class=c1>// 停止定时器
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>CommandReg</span><span class=p>,</span> <span class=n>PCD_IDLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  寻卡，读取卡类型号
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  reqMode: 寻卡方式
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  TagType: 返回卡片类型
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval 成功返回MI_OK
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>MFRC522_Request</span><span class=p>(</span><span class=n>u8</span> <span class=n>reqMode</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>TagType</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u16</span> <span class=n>backBits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>BitFramingReg</span><span class=p>,</span> <span class=mh>0x07</span><span class=p>);</span>          <span class=c1>// TxLastBists = BitFramingReg[2..0]
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>TagType</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>reqMode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span> <span class=o>=</span> <span class=nf>MFRC522_ToCard</span><span class=p>(</span><span class=n>PCD_TRANSCEIVE</span><span class=p>,</span> <span class=n>TagType</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>TagType</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>backBits</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=n>status</span> <span class=o>!=</span> <span class=n>MI_OK</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=n>backBits</span> <span class=o>!=</span> <span class=mh>0x10</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>status</span> <span class=o>=</span> <span class=n>MI_ERR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  防冲突检测，读取选中卡片的卡序列号
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  serNum: 返回4字节卡序列号,第5字节为校验字节
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval 成功返回MI_OK
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>MFRC522_Anticoll</span><span class=p>(</span><span class=n>u8</span> <span class=o>*</span><span class=n>serNum</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>serNumCheck</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u16</span> <span class=n>unLen</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_ClearBitMask</span><span class=p>(</span><span class=n>Status2Reg</span><span class=p>,</span> <span class=mh>0x08</span><span class=p>);</span>         <span class=c1>// TempSensclear
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>MFRC522_ClearBitMask</span><span class=p>(</span><span class=n>CollReg</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>);</span>            <span class=c1>// ValuesAfterColl
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>BitFramingReg</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>);</span>          <span class=c1>// TxLastBists = BitFramingReg[2..0]
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=n>serNum</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>PICC_ANTICOLL1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>serNum</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x20</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span> <span class=o>=</span> <span class=nf>MFRC522_ToCard</span><span class=p>(</span><span class=n>PCD_TRANSCEIVE</span><span class=p>,</span> <span class=n>serNum</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>serNum</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>unLen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>status</span> <span class=o>==</span> <span class=n>MI_OK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* 校验卡序列号 */</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>serNumCheck</span> <span class=o>^=</span> <span class=n>serNum</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>serNumCheck</span> <span class=o>!=</span> <span class=n>serNum</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>status</span> <span class=o>=</span> <span class=n>MI_ERR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_SetBitMask</span><span class=p>(</span><span class=n>CollReg</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>);</span>              <span class=c1>// ValuesAfterColl=1
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  用MF522计算CRC
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  pIndata: 要计算CRC的数据
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  len: 数据长度
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  pOutData: 计算的CRC结果
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval None
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_CalulateCRC</span><span class=p>(</span><span class=n>u8</span> <span class=o>*</span><span class=n>pIndata</span><span class=p>,</span> <span class=n>u8</span> <span class=n>len</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>pOutData</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u16</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_ClearBitMask</span><span class=p>(</span><span class=n>DivIrqReg</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>);</span>          <span class=c1>// CRCIrq = 0
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>MFRC522_SetBitMask</span><span class=p>(</span><span class=n>FIFOLevelReg</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>);</span>         <span class=c1>// 清FIFO指针
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>CommandReg</span><span class=p>,</span> <span class=n>PCD_IDLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 向FIFO中写入数据 */</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>len</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>FIFODataReg</span><span class=p>,</span> <span class=n>pIndata</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 开始CRC计算 */</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>CommandReg</span><span class=p>,</span> <span class=n>PCD_CALCCRC</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 等待CRC计算完成 */</span>
</span></span><span class=line><span class=cl>    <span class=n>i</span> <span class=o>=</span> <span class=mi>1000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>n</span> <span class=o>=</span> <span class=nf>MFRC522_ReadReg</span><span class=p>(</span><span class=n>DivIrqReg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>i</span><span class=o>--</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>while</span><span class=p>((</span><span class=n>i</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>n</span> <span class=o>&amp;</span> <span class=mh>0x04</span><span class=p>));</span>               <span class=c1>// CRCIrq = 1
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 读取CRC计算结果 */</span>
</span></span><span class=line><span class=cl>    <span class=n>pOutData</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=nf>MFRC522_ReadReg</span><span class=p>(</span><span class=n>CRCResultRegL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>pOutData</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=nf>MFRC522_ReadReg</span><span class=p>(</span><span class=n>CRCResultRegH</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_WriteReg</span><span class=p>(</span><span class=n>CommandReg</span><span class=p>,</span> <span class=n>PCD_IDLE</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  选卡，读取卡存储器容量
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  serNum: 传入卡序列号
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval 成功返回卡容量
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>MFRC522_SelectTag</span><span class=p>(</span><span class=n>u8</span> <span class=o>*</span><span class=n>serNum</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u16</span> <span class=n>recvBits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>buffer</span><span class=p>[</span><span class=mi>9</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>buffer</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>PICC_ANTICOLL1</span><span class=p>;</span>                     <span class=c1>// 防撞码1
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>buffer</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x70</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>buffer</span><span class=p>[</span><span class=mi>6</span><span class=p>]</span> <span class=o>=</span> <span class=mh>0x00</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>buffer</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>serNum</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>                  <span class=c1>// buffer[2]-buffer[5]为卡序列号
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>buffer</span><span class=p>[</span><span class=mi>6</span><span class=p>]</span> <span class=o>^=</span> <span class=n>serNum</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>                     <span class=c1>// 卡校验码
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_CalulateCRC</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=mi>7</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>buffer</span><span class=p>[</span><span class=mi>7</span><span class=p>]);</span>     <span class=c1>// buffer[7]-buffer[8]为CRC校验码
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_ClearBitMask</span><span class=p>(</span><span class=n>Status2Reg</span><span class=p>,</span> <span class=mh>0x08</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span> <span class=o>=</span> <span class=nf>MFRC522_ToCard</span><span class=p>(</span><span class=n>PCD_TRANSCEIVE</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>recvBits</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=n>status</span> <span class=o>==</span> <span class=n>MI_OK</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>recvBits</span> <span class=o>==</span> <span class=mh>0x18</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>size</span> <span class=o>=</span> <span class=n>buffer</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  验证卡片密码
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  authMode: 密码验证模式
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  BlockAddr: 块地址
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  Sectorkey: 扇区密码
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  serNum: 卡片序列号
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval 成功返回MI_OK
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>MFRC522_Auth</span><span class=p>(</span><span class=n>u8</span> <span class=n>authMode</span><span class=p>,</span> <span class=n>u8</span> <span class=n>BlockAddr</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>Sectorkey</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>serNum</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u16</span> <span class=n>recvBits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>buff</span><span class=p>[</span><span class=mi>12</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=cm>/* 构造认证数据: 验证模式+块地址+扇区密码+卡序列号 */</span>
</span></span><span class=line><span class=cl>    <span class=n>buff</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>authMode</span><span class=p>;</span>                             <span class=c1>// 验证模式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>buff</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>BlockAddr</span><span class=p>;</span>                            <span class=c1>// 块地址
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>6</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>buff</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>Sectorkey</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>                 <span class=c1>// 扇区密码
</span></span></span><span class=line><span class=cl><span class=c1></span>        
</span></span><span class=line><span class=cl>    <span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>buff</span><span class=p>[</span><span class=n>i</span> <span class=o>+</span> <span class=mi>8</span><span class=p>]</span> <span class=o>=</span> <span class=n>serNum</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>                    <span class=c1>// 卡序列号
</span></span></span><span class=line><span class=cl><span class=c1></span>        
</span></span><span class=line><span class=cl>    <span class=n>status</span> <span class=o>=</span> <span class=nf>MFRC522_ToCard</span><span class=p>(</span><span class=n>PCD_AUTHENT</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=mi>12</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>recvBits</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=n>status</span> <span class=o>!=</span> <span class=n>MI_OK</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=nf>MFRC522_ReadReg</span><span class=p>(</span><span class=n>Status2Reg</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0x08</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=n>status</span> <span class=o>=</span> <span class=n>MI_ERR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  读块数据
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  blockAddr: 块地址
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  recvData: 读出的块数据
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval 成功返回MI_OK
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>MFRC522_ReadBlock</span><span class=p>(</span><span class=n>u8</span> <span class=n>blockAddr</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>recvData</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u16</span> <span class=n>unLen</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>recvData</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>PICC_READ</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>recvData</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>blockAddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_CalulateCRC</span><span class=p>(</span><span class=n>recvData</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>recvData</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>status</span> <span class=o>=</span> <span class=nf>MFRC522_ToCard</span><span class=p>(</span><span class=n>PCD_TRANSCEIVE</span><span class=p>,</span> <span class=n>recvData</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=n>recvData</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>unLen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=n>status</span> <span class=o>!=</span> <span class=n>MI_OK</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=n>unLen</span> <span class=o>!=</span> <span class=mh>0x90</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>status</span> <span class=o>=</span> <span class=n>MI_ERR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  写块数据
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  blockAddr: 块地址
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  writeData: 向块写16字节数据
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval 成功返回MI_OK
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=n>u8</span> <span class=nf>MFRC522_WriteBlock</span><span class=p>(</span><span class=n>u8</span> <span class=n>blockAddr</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>writeData</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u16</span> <span class=n>recvBits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>buff</span><span class=p>[</span><span class=mi>18</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>buff</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>PICC_WRITE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>buff</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>blockAddr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_CalulateCRC</span><span class=p>(</span><span class=n>buff</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>buff</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>status</span> <span class=o>=</span> <span class=nf>MFRC522_ToCard</span><span class=p>(</span><span class=n>PCD_TRANSCEIVE</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>recvBits</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=n>status</span> <span class=o>!=</span> <span class=n>MI_OK</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=n>recvBits</span> <span class=o>!=</span> <span class=mi>4</span><span class=p>)</span> <span class=o>||</span> <span class=p>((</span><span class=n>buff</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0x0F</span><span class=p>)</span> <span class=o>!=</span> <span class=mh>0x0A</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>status</span> <span class=o>=</span> <span class=n>MI_ERR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>status</span> <span class=o>==</span> <span class=n>MI_OK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/* 向FIFO写16Byte数据 */</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>16</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>buff</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>writeData</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=nf>MFRC522_CalulateCRC</span><span class=p>(</span><span class=n>buff</span><span class=p>,</span> <span class=mi>16</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>buff</span><span class=p>[</span><span class=mi>16</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=n>status</span> <span class=o>=</span> <span class=nf>MFRC522_ToCard</span><span class=p>(</span><span class=n>PCD_TRANSCEIVE</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=mi>18</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>recvBits</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>((</span><span class=n>status</span> <span class=o>!=</span> <span class=n>MI_OK</span><span class=p>)</span> <span class=o>||</span> <span class=p>(</span><span class=n>recvBits</span> <span class=o>!=</span> <span class=mi>4</span><span class=p>)</span> <span class=o>||</span> <span class=p>((</span><span class=n>buff</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&amp;</span> <span class=mh>0x0F</span><span class=p>)</span> <span class=o>!=</span> <span class=mh>0x0A</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>status</span> <span class=o>=</span> <span class=n>MI_ERR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>  * @brief  命令卡片进入休眠状态
</span></span></span><span class=line><span class=cl><span class=cm>  * @param  None
</span></span></span><span class=line><span class=cl><span class=cm>  * @retval None
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>MFRC522_Halt</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>u16</span> <span class=n>unLen</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>u8</span> <span class=n>buff</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>buff</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>PICC_HALT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>buff</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_CalulateCRC</span><span class=p>(</span><span class=n>buff</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>buff</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nf>MFRC522_ToCard</span><span class=p>(</span><span class=n>PCD_TRANSCEIVE</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=n>buff</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>unLen</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4 id=delayh><a class=header-anchor href=#delayh></a>delay.h</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> ******************************************************************************
</span></span></span><span class=line><span class=cl><span class=cm> * @file    delay.h
</span></span></span><span class=line><span class=cl><span class=cm> * @author  qrshxc@163.com
</span></span></span><span class=line><span class=cl><span class=cm> * @version V1.0
</span></span></span><span class=line><span class=cl><span class=cm> * @date    2025.10.7
</span></span></span><span class=line><span class=cl><span class=cm> * @brief   系统延时函数头文件
</span></span></span><span class=line><span class=cl><span class=cm> ******************************************************************************
</span></span></span><span class=line><span class=cl><span class=cm> **/</span>
</span></span><span class=line><span class=cl><span class=cp>#ifndef _DELAY_H
</span></span></span><span class=line><span class=cl><span class=cp>#define _DELAY_H
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;stm32f4xx.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>delay_us</span><span class=p>(</span><span class=n>u32</span> <span class=n>nus</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>delay_ms</span><span class=p>(</span><span class=n>u32</span> <span class=n>nms</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span></code></pre></div><h4 id=delayc><a class=header-anchor href=#delayc></a>delay.c</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> ******************************************************************************
</span></span></span><span class=line><span class=cl><span class=cm> * @file    delay.c 
</span></span></span><span class=line><span class=cl><span class=cm> * @author  qrshxc@163.com
</span></span></span><span class=line><span class=cl><span class=cm> * @version V1.0
</span></span></span><span class=line><span class=cl><span class=cm> * @brief   延时函数实现
</span></span></span><span class=line><span class=cl><span class=cm> *          功能：基于SysTick定时器的精确延时
</span></span></span><span class=line><span class=cl><span class=cm> ******************************************************************************
</span></span></span><span class=line><span class=cl><span class=cm> **/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;delay.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief  微秒级延时
</span></span></span><span class=line><span class=cl><span class=cm> * @param  nus: 微秒数
</span></span></span><span class=line><span class=cl><span class=cm> * @retval None
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>delay_us</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>nus</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>SysTick</span><span class=o>-&gt;</span><span class=n>CTRL</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>                    <span class=cm>/* 关闭SysTick */</span>
</span></span><span class=line><span class=cl>    <span class=n>SysTick</span><span class=o>-&gt;</span><span class=n>LOAD</span> <span class=o>=</span> <span class=n>nus</span> <span class=o>*</span> <span class=mi>21</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>         <span class=cm>/* 设置重载值 */</span>
</span></span><span class=line><span class=cl>    <span class=n>SysTick</span><span class=o>-&gt;</span><span class=n>VAL</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>                     <span class=cm>/* 清空计数器 */</span>
</span></span><span class=line><span class=cl>    <span class=n>SysTick</span><span class=o>-&gt;</span><span class=n>CTRL</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>                    <span class=cm>/* 开启SysTick，使用内核时钟 */</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>((</span><span class=n>SysTick</span><span class=o>-&gt;</span><span class=n>CTRL</span> <span class=o>&amp;</span> <span class=mh>0x00010000</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span> <span class=cm>/* 等待计时完成 */</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>SysTick</span><span class=o>-&gt;</span><span class=n>CTRL</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>                    <span class=cm>/* 关闭SysTick */</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @brief  毫秒级延时
</span></span></span><span class=line><span class=cl><span class=cm> * @param  nms: 毫秒数
</span></span></span><span class=line><span class=cl><span class=cm> * @retval None
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>delay_ms</span><span class=p>(</span><span class=kt>uint32_t</span> <span class=n>nms</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>SysTick</span><span class=o>-&gt;</span><span class=n>CTRL</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>                    <span class=cm>/* 关闭SysTick */</span>
</span></span><span class=line><span class=cl>    <span class=n>SysTick</span><span class=o>-&gt;</span><span class=n>LOAD</span> <span class=o>=</span> <span class=n>nms</span> <span class=o>*</span> <span class=mi>21</span> <span class=o>*</span> <span class=mi>1000</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>  <span class=cm>/* 设置重载值 */</span>
</span></span><span class=line><span class=cl>    <span class=n>SysTick</span><span class=o>-&gt;</span><span class=n>VAL</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>                     <span class=cm>/* 清空计数器 */</span>
</span></span><span class=line><span class=cl>    <span class=n>SysTick</span><span class=o>-&gt;</span><span class=n>CTRL</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>                    <span class=cm>/* 开启SysTick，使用内核时钟 */</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>((</span><span class=n>SysTick</span><span class=o>-&gt;</span><span class=n>CTRL</span> <span class=o>&amp;</span> <span class=mh>0x00010000</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span> <span class=cm>/* 等待计时完成 */</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>SysTick</span><span class=o>-&gt;</span><span class=n>CTRL</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>                    <span class=cm>/* 关闭SysTick */</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h4><a class=header-anchor href=#></a></h4></div><footer class=article-footer><ul class=article-tag-list itemprop=keywords></ul></footer></div><nav id=article-nav data-aos=fade-up><div class="article-nav-link-wrap article-nav-link-left"><img data-src=https://d-sketon.top/img/_backwebp/bg1.webp data-sizes=auto alt="STM32 SPI接口与Flash存储芯片完全指南" class=lazyload>
<a href=https://qrshxc.github.io/post/spiflash/></a><div class=article-nav-caption>前一篇</div><h3 class=article-nav-title>STM32 SPI接口与Flash存储芯片完全指南</h3></div><div class="article-nav-link-wrap article-nav-link-right"><img data-src=https://d-sketon.top/img/_backwebp/bg1.webp data-sizes=auto alt=IIC总线通信与AT24C02存储芯片及OLED屏应用详解 class=lazyload>
<a href=https://qrshxc.github.io/post/iic/></a><div class=article-nav-caption>后一篇</div><h3 class=article-nav-title>IIC总线通信与AT24C02存储芯片及OLED屏应用详解</h3></div></nav></article></section></div><footer id=footer><div style=width:100%;overflow:hidden><div class=footer-line></div></div><div id=footer-info><div><span class=icon-copyright></span>
2020 -
2025
<span class="footer-info-sep rotate"></span>
黄小冲</div><div>基于&nbsp;<a href=https://gohugo.io/ target=_blank>Hugo</a>&nbsp; Theme.<a href=https://github.com/D-Sketon/hugo-theme-reimu target=_blank>Reimu</a></div><div><span class=icon-brush>&nbsp;
74.1k
</span>&nbsp;|&nbsp;
<span class=icon-coffee>&nbsp;
02:45</span></div><div class=footer-beian><a target=_blank rel=noopener href=https://beian.miit.gov.cn>赣ICP备2025054780号-1</a></div><div><span class=icon-eye></span>
<span id=busuanzi_container_site_pv>总访问量&nbsp;<span id=busuanzi_value_site_pv></span></span>
&nbsp;|&nbsp;
<span class=icon-user></span>
<span id=busuanzi_container_site_uv>总访客量&nbsp;<span id=busuanzi_value_site_uv></span></span></div></div></footer><div class=sidebar-top><div class="sidebar-top-taichi rotate"></div><div class=arrow-up></div></div><div id=mask class=hide></div></div><nav id=mobile-nav><div class=sidebar-wrap><div class=sidebar-toc-sidebar><div class=sidebar-toc><h3 class=toc-title>文章目录</h3><div class="sidebar-toc-wrapper toc-div-class"><nav id=TableOfContents><ul><li><a href=#1-基本概念>1. 基本概念</a></li><li><a href=#2接口说明>2.接口说明</a></li><li><a href=#3工作模式>3.工作模式</a></li><li><a href=#4通信机制>4.通信机制</a></li><li><a href=#5访问流程>5.访问流程</a></li><li><a href=#6程序设计>6.程序设计</a><ul><li></li></ul></li></ul></nav></div></div></div><div class="sidebar-common-sidebar hidden"><div class=sidebar-author><img data-src=/avatar/avatar.webp data-sizes=auto alt=黄小冲 class=lazyload><div class=sidebar-author-name>黄小冲</div><div class=sidebar-description>记录成长与学习的足迹</div></div><div class=sidebar-state><div class=sidebar-state-article><div>文章</div><div class=sidebar-state-number>32</div></div><div class=sidebar-state-category><div>分类</div><div class=sidebar-state-number>0</div></div><div class=sidebar-state-tag><div>标签</div><div class=sidebar-state-number>0</div></div></div><div class=sidebar-social><div class="icon-github sidebar-social-icon"><a href=https://github.com/qrshxc itemprop=url target=_blank aria-label=github rel="noopener external nofollow noreferrer"></a></div><div class="icon-google sidebar-social-icon"><a href=https://plus.google.com/crees itemprop=url target=_blank aria-label=google rel="noopener external nofollow noreferrer"></a></div></div><div class=sidebar-menu><div class=sidebar-menu-link-wrap><a class=sidebar-menu-link-dummy href=/ aria-label=首页></a><div class='sidebar-menu-icon icon rotate'>&#xe62b;</div><div class=sidebar-menu-link>首页</div></div><div class=sidebar-menu-link-wrap><a class=sidebar-menu-link-dummy href=/archives aria-label=归档></a><div class='sidebar-menu-icon icon rotate'>&#xe62b;</div><div class=sidebar-menu-link>归档</div></div><div class=sidebar-menu-link-wrap><a class=sidebar-menu-link-dummy href=/about aria-label=关于></a><div class='sidebar-menu-icon icon rotate'>&#xe62b;</div><div class=sidebar-menu-link>关于</div></div><div class=sidebar-menu-link-wrap><a class=sidebar-menu-link-dummy href=/friend aria-label=友链></a><div class='sidebar-menu-icon icon rotate'>&#xe62b;</div><div class=sidebar-menu-link>友链</div></div></div></div></div><div class=sidebar-btn-wrapper><div class="sidebar-toc-btn current"></div><div class=sidebar-common-btn></div></div></nav></div><script src=https://npm.webcache.cn/lazysizes@5.3.2/lazysizes.min.js integrity=sha384-3gT/vsepWkfz/ff7PpWNUeMzeWoH3cDhm/A8jM7ouoAK0/fP/9bcHHR5kHq2nf+e crossorigin=anonymous></script><script src=https://npm.webcache.cn/clipboard@2.0.11/dist/clipboard.min.js integrity=sha384-J08i8An/QeARD9ExYpvphB8BsyOj3Gh2TSh1aLINKO3L0cMSH2dN3E22zFoXEi0Q crossorigin=anonymous></script><script src=/js/main.js integrity crossorigin=anonymous></script><script src=/js/aos.js integrity crossorigin=anonymous></script><script>var aosInit=()=>{AOS.init({duration:1e3,easing:"ease",once:!0,offset:50})};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",aosInit):aosInit()</script><script src=/js/pjax_main.js integrity crossorigin=anonymous data-pjax></script><script src=https://npm.webcache.cn/mouse-firework@0.1.0/dist/index.umd.js integrity=sha384-KM6i7tu43nYd6e0beIljxHMC5tZc58XBDu7pPA58w50h18Jsx7gLdimfS09RXlKv crossorigin=anonymous></script><script>if(window.firework){const e=JSON.parse('{"excludeelements":["a","button"],"particles":[{"colors":["#ff5252","#ff7c7c","#ffafaf","#ffd0d0"],"duration":[1200,1800],"easing":"easeOutExpo","move":["emit"],"number":20,"shape":"circle","shapeOptions":{"alpha":[0.3,0.5],"radius":[16,32]}},{"colors":["#ff0000"],"duration":[1200,1800],"easing":"easeOutExpo","move":["diffuse"],"number":1,"shape":"circle","shapeOptions":{"alpha":[0.2,0.5],"lineWidth":6,"radius":20}}]}');e.excludeElements=e.excludeelements,delete e.excludeelements,window.firework(e)}</script><div id=lazy-script><div><script data-pjax>window.REIMU_POST={author:"黄小冲",title:"STM32与RFID模块(MFRC522)完全应用指南",url:"https://qrshxc.github.io/post/rfid/",description:` 一、RFID 模块的原理与应用 1. 基本概念 RFID 技术也简称为射频识别技术，是20 世纪40 年代开始出现的一种自动识别技术。RFID通过无线射频信号获取物体的相关数据，并对物体加以识别，RFID 技术不需要和被识别物体进行直接接触就可以完成物体信息的处理，也不需要人工干预，可以实现无接触式信息传递，能应用在各种较为恶劣的环境中。所以说RFID 技术是一种快速、高效的采集和处理物体信息的自动识别技术。
`,cover:"https://qrshxc.github.io/images/banner.webp"}</script><script src=/js/insert_highlight.js integrity crossorigin=anonymous data-pjax></script><script type=module data-pjax>
        const PhotoSwipeLightbox = (await safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe-lightbox.esm.min.js", "sha384-DiL6M\/gG\u002bwmTxmCRZyD1zee6lIhawn5TGvED0FOh7fXcN9B0aZ9dexSF\/N6lrZi\/")).default;

        const pswp = () => {
          if (_$$('.article-entry a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-entry',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8\u002boTJ7m3DfYEWX1fu1scuS4\u002bs")
            }).init();
          }
          if(_$$('.article-gallery a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-gallery',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8\u002boTJ7m3DfYEWX1fu1scuS4\u002bs")
            }).init();
          }
          window.lightboxStatus = 'done';
          window.removeEventListener('lightbox:ready', pswp);
        }
        if(window.lightboxStatus === 'ready') {
          pswp()
        } else {
          window.addEventListener('lightbox:ready', pswp);
        }
      </script></div></div><script src=https://npm.webcache.cn/busuanzi@2.3.0/bsz.pure.mini.js async integrity=sha384-0M75wtSkhjIInv4coYlaJU83+OypaRCIq2SukQVQX04eGTCBXJDuWAbJet56id+S crossorigin=anonymous></script><script>"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().then(e=>{for(let t of e)t.unregister()})</script><script>const reimuCopyright=String.raw`
   ______     ______     __     __    __     __  __    
  /\  == \   /\  ___\   /\ \   /\ "-./  \   /\ \/\ \   
  \ \  __<   \ \  __\   \ \ \  \ \ \-./\ \  \ \ \_\ \  
   \ \_\ \_\  \ \_____\  \ \_\  \ \_\ \ \_\  \ \_____\ 
    \/_/ /_/   \/_____/   \/_/   \/_/  \/_/   \/_____/ 
                                                    
  `;console.log(String.raw`%c ${reimuCopyright}`,"color: #ff5252;"),console.log("%c Theme.Reimu %c https://github.com/D-Sketon/hugo-theme-reimu ","color: white; background: #ff5252; padding:5px 0;","padding:4px;border:1px solid #ff5252;")</script></body></html>